# 퍼스널 컬러 기반 립 추천 시스템
## 알고리즘 구현 명세서 (Algorithm Specification)

> 본 문서는 **기능 명세서 v1.0**을 기준으로,
> 실제 구현을 담당하는 개발 조직이 참고해야 할 **알고리즘 설계 문서**이다.
>
> 본 시스템은 머신러닝 기반이 아닌, **설명 가능하고 재현 가능한 규칙 기반(Color Science 기반)** 알고리즘을 사용한다.

---

## 1. 알고리즘 설계 철학

### 1.1 목적
- 사용자의 얼굴 이미지에서 피부 색 특성을 분석
- 사전에 정의된 **12가지 퍼스널 컬러 타입 중 1개를 확정**
- 해당 타입에 매핑된 **립 제품 1종을 추천**

> 본 알고리즘은 **"정확한 진단"이 아닌 "가장 조화로운 추천"**을 목표로 한다.

---

## 2. 입력 데이터 정의

### 2.1 입력
- 얼굴 정면 이미지 1장
- 촬영 조건은 외부에서 통제됨 (조명 CCT 고정, 카메라 WB 고정)

### 2.2 전처리 결과
- 피부 ROI 마스크 (입술, 눈, 머리카락 제외)
- ROI 내 픽셀의 평균 LAB 값

```text
Input:
  L_face, a_face, b_face
```

---

## 3. 색상 파생 지표 계산

### 3.1 채도 (Chroma)

```text
C_face = sqrt(a_face^2 + b_face^2)
```

### 3.2 웜/쿨 지표 (Temperature Index)

```text
T_face = b_face + 0.2 * a_face
```

- b*가 온도 판단의 주축
- a*는 혈색(홍조) 영향을 소량 반영

---

## 4. 기준 데이터 구조

각 퍼스널 컬러 타입 k는 다음 기준값을 가진다:

```text
Type_k:
  season ∈ {spring, summer, autumn, winter}
  L_k, a_k, b_k
```

추가로 계산:

```text
C_k = sqrt(a_k^2 + b_k^2)
T_k = b_k + 0.2 * a_k
```

---

## 5. 전체 판정 파이프라인

```text
1. 얼굴 LAB → 파생 지표 계산
2. 계절 판정 (하드 디시전)
3. 계절 내부 타입 점수 계산
4. 최종 타입 1개 선택
5. 타입에 매핑된 립 제품 추천
```

---

## 6. 계절 판정 알고리즘 (Stage 1)

### 6.1 개념
- 계절은 **웜/쿨 성향을 기준으로 명확히 분리**됨
- 계절은 확률이 아닌 **확정 값**으로 취급

### 6.2 계산 방식

각 계절 s에 대해, 해당 계절에 속한 타입들의 **온도 거리 최소값**을 사용

```text
SeasonScore_s = min_k∈s ( |T_face - T_k| )
```

### 6.3 계절 확정

```text
season* = argmin_s SeasonScore_s
```

- 내부적으로는 2위 계절과의 차이를 계산하나
- UI에는 항상 **1개 계절만 출력**

---

## 7. 타입 판정 알고리즘 (Stage 2)

### 7.1 대상
- Stage 1에서 확정된 계절에 속한 타입만 경쟁

### 7.2 기본 색차

```text
DeltaE_k = ΔE(face, reference_k)
```

- CIEDE2000 권장
- 구현 제약 시 CIE76 사용 가능

---

## 8. 패널티 기반 점수 함수

### 8.1 패널티 정의

```text
P_L = max(0, |L_face - L_k| - τ_L)^2
P_C = max(0, |C_face - C_k| - τ_C)^2
P_T = max(0, |T_face - T_k| - τ_T)^2
```

### 8.2 기본 허용 오차

```text
τ_L = 6
τ_C = 7
τ_T = 4
```

---

## 9. 타입별 가중치 (최종 확정)

| 타입 | λ_L | λ_C | λ_T |
|----|----:|----:|----:|
| 라이트 | 1.6 | 0.9 | 2.2 |
| 뮤트 | 0.9 | 1.7 | 2.2 |
| 브라이트 | 1.3 | 1.3 | 2.2 |
| 비비드 | 0.8 | 1.9 | 2.2 |
| 다크 | 1.6 | 1.0 | 2.2 |
| 스트롱 | 1.1 | 1.5 | 2.2 |

---

## 10. 최종 점수 함수

```text
Score_k =
  DeltaE_k
  + λ_T * P_T
  + λ_L * P_L
  + λ_C * P_C
```

```text
BestType = argmin_k Score_k
```

---

## 11. 경계 처리 (내부 로직)

- 1위와 2위 타입 점수 차이가 작은 경우:

```text
if Score_2 - Score_1 < threshold:
  mark_as_boundary = True
```

- threshold 권장값: 1.5
- UI에는 퍼센티지 미노출

---

## 12. 출력 규칙

### 12.1 기본 출력
- 퍼스널 컬러 타입 1개
- 해당 타입에 매핑된 립 제품 1종

### 12.2 사용자 설명 문구 (고정)

> 피부 톤의 밝기와 색감,
> 그리고 웜/쿨 성향을 기준으로
> 가장 조화로운 립 컬러를 추천했습니다.

---

## 13. 구현 시 주의사항

- RGB 직접 비교 금지
- 모든 계산은 LAB 기준
- 평균값 외에 중앙값 사용 가능
- 조명 조건 변경 시 재튜닝 필요

---

## 14. 문서 상태

- Version: 1.0
- Status: 구현 가능 (Ready for Development)
- 변경 시 기능 명세서와 동기화 필요

