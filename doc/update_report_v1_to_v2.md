# 립 시뮬레이션 알고리즘 업데이트 보고서 (v1 → v2)

본 문서는 프로젝트의 첫 번째 커밋 버전에서 두 번째 커밋(`795666a`) 시스템으로 발전하며 수행된 주요 작업과 알고리즘 개선 사항을 정리합니다.

---

## 1. 색체계 전환 및 컬러 불일치 해결 (HSL → RGB / Color Mismatch)

### [색체계 전환]
- **기존 방식**: 초기 버전에서는 내부적으로 **HSL(Hue, Saturation, Lightness)** 기반의 색상 제어 방식을 검토하거나 사용했으나, 이는 직관적인 색상 지정과 OpenCV 및 웹 UI와의 호환성에서 한계가 있었습니다.
- **수정 방식**: 이를 **RGB(Red, Green, Blue)** 색체계 중심으로 전면 개편했습니다. 사용자가 HEX 코드로 입력한 RGB 값을 직접 파싱하여 처리함으로써, 범용적인 컬러 피커와의 동기화를 최적화하고 일관된 결과물을 보장하도록 했습니다.

### [문제점 및 해결]
- **문제점**: 사용자가 파란색(#0000FF)을 선택했음에도 실제 화면에는 오렌지색 계열이 입혀지는 현상이 발생했습니다.
- **수행 작업**:
    - **채널 표준화**: `modules/color.py`에서 BGR과 RGB 채널의 혼동을 방지하기 위해 입력 벡터를 BGR로 명확히 캐스팅하고, OpenCV의 표준 `uint8` 범위를 사용하여 색상을 정규화했습니다.
    - **렌더링 파이프라인 버그 수정**: `render_once.py`에서 색상이 입혀진 이미지(`img_colored`)를 최종 결과물 생성의 베이스로 사용하지 않고, 원본 이미지에 하이라이트만 더하던 로직을 수정하여 선택한 색상이 실제 얼굴 이미지에 반영되도록 조치했습니다.

---

## 2. 윗입술 하이라이트 직선 아티팩트 제거

### [문제점]
윗입술의 하이라이트 마스크가 입술의 곡선을 따르지 않고 부자연스러운 수평 직선 형태로 나타났습니다.

### [수행 작업]
- **좌표계 국지적 정규화 (Local Normalization)**: `modules/lcs.py`에서 Y 좌표(`y_hat`)를 계산할 때 전역적인 상/하 경계값을 사용하던 방식에서, **각 열(X)마다 입술의 실제 경계를 찾아 정규화**하는 방식으로 변경했습니다.
- **효과**: 하이라이트가 입술의 실제 굴곡(M자 곡선)을 자연스럽게 따라가도록 개선되었습니다.

---

## 3. 하이라이트 위치 및 형태 최적화

### [수행 작업]
- **위치 대치**: 사용자의 피드백을 반영하여 윗입술 하이라이트 중심점(`UPPER_CENTER`)을 중앙선 근처에서 **최상단 영역(`-0.8`)**으로 이동시켰습니다.
- **파라미터 기본값 조정**: `app.py`의 기본값을 수정하여 별도의 조절 없이도 자연스러운 상단 하이라이트가 맺히도록 설정했습니다.

---

## 4. Soft Light 블렌딩 모드 및 발색 품질 개선

### [문제점]
기존의 색상 적용 방식은 발색이 뚜렷하지만, 때때로 입술 원본의 질감이 묻히거나 색이 너무 진하게 느껴지는 한계가 있었습니다.

### [수행 작업]
- **Soft Light 블렌딩 구현**: 포토샵의 'Soft Light' 알고리즘을 도입했습니다. 이는 배경의 명암을 보존하면서 색상을 자연스럽게 얹어주는 특성이 있어, 더 투명하고 실제 제품을 바른 듯한 효과를 제공합니다.
- **모드 선택 기능**: `app.py` UI에서 'Normal'과 'Soft Light' 모드를 자유롭게 전환하며 비교할 수 있도록 옵션을 추가했습니다.
- **프리셋 저장**: 선택한 블렌딩 모드가 프리셋(`JSON`)에 함께 저장되도록 연동했습니다.

---

## 5. 베이스 색상 중립화 (Base Desaturation)

### [문제점]
원래의 붉은색 입술 위에 블루, 퍼플, 다심 브라운 등의 특수 컬러를 입힐 경우, 원본의 붉은 기와 섞여 탁해지거나 의도한 색상이 정확하게 발색되지 않는 현상이 있었습니다.

### [수행 작업]
- **채도 감쇄 로직 적용**: 색상을 입히기 전, 마스크 영역 내 원본 이미지의 채도를 슬라이더 수치에 따라 낮추는(Middle-tone Neutralization) 전처리 단계를 추가했습니다.
- **발색 전문성 강화**: 이를 통해 보색 관계의 특수 컬러도 탁해짐 없이 선명하게 시뮬레이션할 수 있게 되었으며, 사용자가 중립화 정도를 0~100%까지 자유롭게 조절할 수 있습니다.

---

## 6. 다크 컬러 발색 개선 및 명도(Value) 제어

### [문제점]
다크 브라운, 딥 버건디 등 명도가 낮은 어두운 색상을 선택했음에도, 원래 입술의 밝기가 그대로 유지되어 결과물이 들뜨거나 색이 충분히 깊어 보이지 않는 현상이 있었습니다.

### [수행 작업]
- **명도 가중치(Value Weight) 도입**: 원본 입술의 명도와 사용자가 선택한 색상의 명도를 블렌딩하는 로직을 추가했습니다.
- **딥 컬러 시뮬레이션 최적화**: `Value Weight` 수치를 높임으로써 대상 색상의 어두운 톤을 강제로 결과물에 입힐 수 있게 되었습니다. 이를 통해 밝은 입술 위에서도 짙고 어두운 메이크업 효과를 완벽하게 재현할 수 있습니다.

---

## 7. 경계 부드러움(Fuzziness/Feathering) 조절 기능

### [문제점]
입술 색상이 입혀지는 경계가 너무 날카로워(Sharp) 합성이 부자연스러운 느낌을 주었습니다.

### [수행 작업]
- **페더링 방향 교정**: 마스크가 안쪽으로 깎여 원본 입술이 노출되던 문제를 해결하기 위해, 경계선에서 바깥쪽으로 감쇄(Outward Falloff)되는 공식을 적용했습니다. 이를 통해 본래의 입술 형태를 보존하며 자연스럽게 번지는 효과를 구현했습니다.
- **소프트 마스크 통합**: 기존에 하이라이트용으로만 쓰이던 소프트 마스크(`lip01`)를 립 컬러 블렌딩 과정에도 적용했습니다.
- **페더링 제어**: `EDGE_UPPER`와 `EDGE_LOWER` 파라미터가 단순 가이드 영역을 넘어, 실제 색상의 **퍼짐 정도(Feathering)**를 제어할 수 있도록 로직을 확장하고 UI 도움말을 업데이트했습니다.

---

## 5. 기타 인프라 및 디버깅 도구
- **환경 구축**: `venv` 및 `requirements.txt`를 통한 실행 환경 표준화.
- **디버깅 스크립트 추가**: `debug_color.py`, `reproduce_color.py` 등을 생성하여 색상 변환 및 좌표계 로직을 독립적으로 검증할 수 있는 환경을 마련했습니다.

---
**보고서 종료**
